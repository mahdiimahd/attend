<!DOCTYPE html>
<html>
<title> attend </title>
<head> 
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<p>Click the button to get your coordinates.</p>
<form method="post"> 
  Uniqname:
  <input type="text" name="uniqname">
  <input type="button" value="attend" onclick="getLocation()">
</form>

<p id="demo"></p>
<p id="distance"></p>
<p id="fingerprint"></p>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fingerprintjs2/2.1.0/fingerprint2.min.js"></script>

<script>
var x = document.getElementById("demo");
var y = document.getElementById("distance");
var z = document.getElementById("fingerprint")

// Hardcoded lat/long of my house for testing
var home_lat = 42.2695707
var home_long = -83.7347724

// Function to print unique fingerprint of each device
setTimeout(function () {
        Fingerprint2.get(function (components) {
            var values = components.map(function (component) { return component.value })
            var murmur = Fingerprint2.x64hash128(values.join(''), 31)
            z.innerHTML = murmur // an array of components: {key: ..., value: ...}
        })  
    }, 500)

function error(err) {
  console.warn(`ERROR(${err.code}): ${err.message}`);
}

// This code gets location
function getLocation() {
    var geo_options = {
  enableHighAccuracy: true, 
  maximumAge        : 0, 
  timeout           : 7000
};
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(showPosition, error, geo_options);
  } else { 
    x.innerHTML = "Geolocation is not supported by this browser.";
  }
}
function showPosition(position) {
  x.innerHTML = "Latitude: " + position.coords.latitude + 
  "<br>Longitude: " + position.coords.longitude;
  y.innerHTML = "Distance is: " + getDistanceFromLatLonInKm(position.coords.latitude, position.coords.longitude
  , home_lat, home_long) + " ft";
}

function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
  var R = 6371; // Radius of the earth in km
  var dLat = deg2rad(lat2-lat1);  // deg2rad below
  var dLon = deg2rad(lon2-lon1); 
  var a = 
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
    Math.sin(dLon/2) * Math.sin(dLon/2)
    ; 
  var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
  var d = R * c; // Distance in km
  return d * 3280.84;
}

function deg2rad(deg) {
  return deg * (Math.PI/180)
}
</script>

</body>
</html>
